"use strict";angular.module("app.core",[]),angular.module("app",["ngRoute","ui.router","ngSanitize","ngCookies","app.core"]).config(["$stateProvider","$httpProvider","$locationProvider",function($stateProvider,$httpProvider,$locationProvider){$stateProvider.state("home",{url:"/",templateUrl:"/js/views/controllers/home.html",controller:"HomeController",controllerAs:"vm"}).state("home.book",{url:"books/:bookId/:chapterId?verseId",templateUrl:"/js/views/controllers/book.html",controller:"BookController",controllerAs:"vm"}).state("home.bookWithTranslation",{url:":translation/books/:bookId/:chapterId?verseId",templateUrl:"/js/views/controllers/book.html",controller:"BookController",controllerAs:"vm"}).state("home.search",{url:"search/?query",templateUrl:"/js/views/controllers/search.html",controller:"SearchController",controllerAs:"vm"}),$locationProvider.html5Mode(!0)}]);var coreAppEnv={};window&&(coreAppEnv=angular.extend(coreAppEnv,window.__coreAppEnv)),angular.module("app.core").value("URL",coreAppEnv.URL).value("API_URL",coreAppEnv.API_URL).value("DEFAULT_TRANSLATION",coreAppEnv.DEFAULT_TRANSLATION),function(){function BookController($scope,$transitions,$state,$stateParams,ApiService,ModalStateService,TranslationStateService,BookSelectorStateService,TitleStateService){function init(){vm.book={},ApiService.getText(bookId,chapterId,TranslationStateService.getCurrent()).then(function(data){vm.versesLeft=[],vm.versesRight=[],vm.book=data[0].book;var testament="OT"==vm.book.testament?"Old Testament":"New Testament";TitleStateService.change("<b>"+vm.book.name+'</b><span class="hide-xs"> - <i>'+testament+"</i></span>");for(var i=0;i<data.length;i++)null!==verseId&&data[i].verseId==verseId&&(data[i].highlight=!0),i<data.length/2?vm.versesLeft.push(data[i]):vm.versesRight.push(data[i])}).then(function(){null!=verseId&&setTimeout(function(){var elem=document.getElementById("verse"+verseId);elem.scrollIntoView(),window.scroll(window.scrollX,window.scrollY-75)},250)})}function onStartTransition(){TranslationStateService.onChange("book",null)}function onKeyDownEvent(e){27===e.keyCode&&(ModalStateService.close(),$scope.$apply()),39===e.keyCode&&BookSelectorStateService.publish("next"),37===e.keyCode&&BookSelectorStateService.publish("previous")}function open(placement,verse){var element=document.getElementById("crossReferenceModal");element.style.left=null,element.style.left=null,"left"===placement?element.style.left=0:element.style.right=0;for(var verses=vm.versesLeft.concat(vm.versesRight),i=0;i<verses.length;i++)if(verses[i].hasOwnProperty("highlight")){verses[i].highlight=!1;break}ModalStateService.open(verse)}var vm=this;vm.book={},vm.versesLeft=[],vm.versesRight=[],vm.open=open;var bookId=1,chapterId=1,verseId=null;$stateParams.hasOwnProperty("bookId")&&(bookId=$stateParams.bookId),$stateParams.hasOwnProperty("chapterId")&&(chapterId=$stateParams.chapterId),$stateParams.hasOwnProperty("verseId")&&(verseId=$stateParams.verseId),$transitions.onStart({},onStartTransition),TranslationStateService.onChange("book",function(){init()}),init(),document.body.onkeydown=onKeyDownEvent}angular.module("app.core").controller("BookController",BookController),BookController.$inject=["$scope","$transitions","$state","$stateParams","ApiService","ModalStateService","TranslationStateService","BookSelectorStateService","TitleStateService"]}(),function(){function HomeController($state,$transitions,SearchStateService,ModalStateService,TitleStateService){function onSuccessTransition(transition){"home.book"==transition.to().name&&ModalStateService.onOpen(closeNavigation)}function onTitleChange(value){vm.title=value}function onSearchResults(){isMobile()&&closeNavigation()}function closeNavigation(){vm.navIsOpen=!1,enableMobileScrolling()}function onToggleLeftNav(){vm.navIsOpen=!vm.navIsOpen,vm.navIsOpen?disableMobileScrolling():enableMobileScrolling()}function isMobile(){return window.innerWidth<=635}function enableMobileScrolling(){if(isMobile()){var elem=document.querySelector("body");elem.style.overflow="initial"}}function disableMobileScrolling(){if(isMobile()){var elem=document.querySelector("body");elem.style.overflow="hidden"}}var vm=this;vm.navIsOpen=!1,vm.title="Loading...",vm.onToggleLeftNav=onToggleLeftNav,SearchStateService.onReady(onSearchResults),TitleStateService.onChange(onTitleChange),ModalStateService.onOpen(closeNavigation),$transitions.onSuccess({},onSuccessTransition),isMobile()||(vm.navIsOpen=!0),"home"===$state.$current.name&&$state.go("home.book",{bookId:1,chapterId:1},{reload:!0})}angular.module("app.core").controller("HomeController",HomeController),HomeController.$inject=["$state","$transitions","SearchStateService","ModalStateService","TitleStateService"]}(),function(){function SearchController($scope,$transitions,$state,$stateParams,ApiService,TranslationStateService,SearchStateService,TitleStateService){function onStartTransition(){TranslationStateService.onChange("search",null)}function doSearch(){TitleStateService.change("Searching..."),vm.isLoading=!0,ApiService.search(vm.query,translation,offset,limit).then(onSearch)}function loadMore(){vm.isLoading=!0,offset+=limit,ApiService.search(vm.query,translation,offset,limit).then(onLoadMore)}function onSearch(result){window.scrollTo(0,0),offset=0,vm.result=result,vm.isLoading=!1,TitleStateService.change("<b>Found "+vm.result.total+' Results</b><span class="hide-xs"> - <i>In '+translation+"</i></span>"),SearchStateService.ready()}function onLoadMore(result){vm.result.items=vm.result.items.concat(result.items),vm.isLoading=!1}var vm=this;vm.query=$stateParams.query,vm.isLoading=!0,vm.result={total:0,items:[]},vm.loadMore=loadMore;var translation=TranslationStateService.getCurrent(),limit=100,offset=0;doSearch(),TranslationStateService.onChange("search",function(obj){translation=obj.abbreviation,doSearch()}),$transitions.onStart({},onStartTransition)}angular.module("app.core").controller("SearchController",SearchController),SearchController.$inject=["$scope","$transitions","$state","$stateParams","ApiService","TranslationStateService","SearchStateService","TitleStateService"]}(),function(){function bookSelector(){return{restrict:"E",scope:{},controller:ctrl,controllerAs:"vm",bindToController:!0,templateUrl:"/js/views/directives/book-selector.html"}}function ctrl($scope,ApiService,$q,$state,$stateParams,BookSelectorStateService){function getBooks(){return ApiService.getBooks().then(function(books){return vm.books=books,setSelectedBook(stateBookId),stateBookId}).then(ApiService.getChaptersFromBook).then(function(chapters){vm.chapters=chapters,setSelectedChapter(stateChapterId)})["finally"](function(){vm.isLoading=!1})}function onSelectBook(book){setSelectedChapter(1),ApiService.getChaptersFromBook(book.id).then(function(chapters){vm.chapters=chapters}),checkBtnState(book.id,1),$state.go("home.book",{bookId:book.id,chapterId:1,verseId:null})}function onSelectChapter(chapter){checkBtnState(vm.selected.book.id,chapter.id),$state.go("home.book",{bookId:vm.selected.book.id,chapterId:chapter.id,verseId:null})}function onPreviousClick(){var bookId=vm.selected.book.id,chapterId=vm.selected.chapter.id;chapterId-1===0?(bookId--,vm.isLoading=!0,ApiService.getChaptersFromBook(bookId).then(function(chapters){vm.chapters=chapters,vm.isLoading=!1,setSelectedBook(bookId),setSelectedChapter(chapters.length),checkBtnState(bookId,chapters.length),$state.go("home.book",{bookId:bookId,chapterId:chapters.length,verseId:null})})):(chapterId--,setSelectedChapter(chapterId),checkBtnState(bookId,chapterId),$state.go("home.book",{bookId:bookId,chapterId:chapterId,verseId:null}))}function onNextClick(){var maxChapters=vm.chapters.length,bookId=vm.selected.book.id,chapterId=vm.selected.chapter.id;chapterId+1>maxChapters?(bookId++,chapterId=1,$scope.isLoading=!0,ApiService.getChaptersFromBook(bookId).then(function(chapters){vm.chapters=chapters,$scope.isLoading=!1})):chapterId++,setSelectedBook(bookId),setSelectedChapter(chapterId),checkBtnState(bookId,chapterId),$state.go("home.book",{bookId:bookId,chapterId:chapterId,verseId:null})}function setSelectedBook(bookId){for(var index in vm.books)if(vm.books[index].id===bookId){vm.selected.book=vm.books[index];break}null==vm.selected.book.id&&(vm.selected.book=vm.books[0])}function setSelectedChapter(chapterId){for(var index in vm.chapters)if(vm.chapters[index].id===chapterId){vm.selected.chapter=vm.chapters[index];break}null==vm.selected.chapter.id&&(vm.selected.chapter=vm.chapters[0])}function checkBtnState(bookId,chapterId){vm.disablePreviousBtn=1===bookId&&1===chapterId,vm.disableNextBtn=66===bookId&&22===chapterId}var vm=this;vm.books=[],vm.selected={book:{id:null},chapter:{id:null}},vm.disablePreviousBtn=!1,vm.disableNextBtn=!1,vm.isLoading=!0,vm.onSelectBook=onSelectBook,vm.onSelectChapter=onSelectChapter,vm.onPreviousClick=onPreviousClick,vm.onNextClick=onNextClick;var stateBookId=parseInt($stateParams.bookId),stateChapterId=parseInt($stateParams.chapterId);stateBookId||(stateBookId=1),stateChapterId||(stateChapterId=1),checkBtnState(stateBookId,stateChapterId),getBooks(),BookSelectorStateService.subscribe("next",function(){return!vm.disableNextBtn&&void vm.onNextClick()}),BookSelectorStateService.subscribe("previous",function(){return!vm.disablePreviousBtn&&void vm.onPreviousClick()})}angular.module("app.core").directive("bookSelector",bookSelector),ctrl.$inject=["$scope","ApiService","$q","$state","$stateParams","BookSelectorStateService"]}(),function(){function crossReferenceModal(){return{restrict:"E",scope:{},controller:ctrl,controllerAs:"vm",bindToController:!0,templateUrl:"/js/views/directives/cross-reference-modal.html"}}function ctrl($scope,$transitions,ApiService,ModalStateService,TranslationStateService){function init(){ApiService.getCrossReferences(currentVerse.id,TranslationStateService.getCurrent()).then(function(data){vm.relatedVerses=data,vm.isLoading=!1,document.getElementById("crossReferenceModal").scrollTop=0})}function onStartTransition(){TranslationStateService.onChange("crossRef",null),ModalStateService.clear()}function close(){vm.isOpen=!1}var vm=this;vm.verse={},vm.relatedVerses=[],vm.isOpen=!1,vm.close=close;var currentVerse=null;TranslationStateService.onChange("crossRef",function(){return!!vm.isOpen&&void init()}),$transitions.onStart({},onStartTransition),ModalStateService.onOpen(function(verse){null!==currentVerse&&(currentVerse.highlight=!1),currentVerse=verse,currentVerse.highlight=!0,vm.isOpen=!0,vm.isLoading=!0,init()}),ModalStateService.onClose(function(){vm.isOpen=!1})}angular.module("app.core").directive("crossReferenceModal",crossReferenceModal),ctrl.$inject=["$scope","$transitions","ApiService","ModalStateService","TranslationStateService"]}(),function(){function searchInput(){return{restrict:"E",scope:{},controller:ctrl,controllerAs:"vm",bindToController:!0,templateUrl:"/js/views/directives/search-input.html"}}function ctrl($transitions,$state,$stateParams,SearchStateService){function init(){$transitions.onStart({},onStartTransition),SearchStateService.onReady(onReady)}function onKeyPress(event){var keyCode=event.which||event.keyCode;13===keyCode&&onSearch(vm.searchQuery)}function onStartTransition(transition){vm.isLoading=!0,"home.search"!==transition.to().name&&(vm.isLoading=!1)}function onReady(){vm.isLoading=!1}function onSearch(searchQuery){$state.go("home.search",{query:searchQuery})}var vm=this;vm.searchQuery="",vm.onSearch=onSearch,vm.onKeyPress=onKeyPress,vm.isLoading=!1,$stateParams.query&&(vm.searchQuery=$stateParams.query),init()}angular.module("app.core").directive("searchInput",searchInput),ctrl.$inject=["$transitions","$state","$stateParams","SearchStateService"]}(),function(){function translationSelector(){return{restrict:"E",scope:{},controller:ctrl,controllerAs:"vm",bindToController:!0,templateUrl:"/js/views/directives/translation-selector.html"}}function ctrl($scope,ApiService,$q,TranslationStateService){function getTranslations(){return ApiService.getTranslations().then(function(translations){for(var i=0;i<translations.length;i++)translations[i].name=translations[i].abbreviation,TranslationStateService.getCurrent().toLowerCase()==translations[i].abbreviation.toLowerCase()&&(vm.selected.translation=translations[i]);vm.translations=translations,vm.isLoading=!1})}function onSelectTranslation(translation){TranslationStateService.change(translation)}var vm=this;vm.translations=[],vm.selected={translation:null},vm.isLoading=!0,vm.onSelectTranslation=onSelectTranslation,getTranslations()}angular.module("app.core").directive("translationSelector",translationSelector),ctrl.$inject=["$scope","ApiService","$q","TranslationStateService"]}(),function(){function ApiService($http,API_URL,$q){function getTranslations(){return _get("/translations")}function getCrossReferences(verseId,translation){return _get("/verse/"+verseId+"/relations",{params:{translation:translation}})}function getBooks(){return _get("/books")}function getChaptersFromBook(bookId){return _get("/books/"+bookId+"/chapters")}function getMaxChapterFromBook(bookId){var deferred=$q.defer();return _get("/books/"+bookId+"/chapters").then(function(data){deferred.resolve(data[data.length-1].id)})["catch"](function(){deferred.reject()}),deferred.promise}function getText(bookId,chapterId,translation){return _get("/books/"+bookId+"/chapters/"+chapterId,{params:{translation:translation}})}function search(query,translation,offset,limit){return _get("/search",{params:{query:query,translation:translation,offset:offset,limit:limit}})}function _getHttpOptions(endpoint,options){var defaultOptions={},httpOptions={};return httpOptions="object"==typeof options?angular.extend(options,defaultOptions):defaultOptions}function _get(endpoint,options){var url=API_URL+endpoint,httpOptions=_getHttpOptions(endpoint,options);return $http.get(url,httpOptions).then(function(response){return response.data})}return{getTranslations:getTranslations,getCrossReferences:getCrossReferences,getBooks:getBooks,getChaptersFromBook:getChaptersFromBook,getMaxChapterFromBook:getMaxChapterFromBook,getText:getText,search:search}}angular.module("app.core").service("ApiService",ApiService),ApiService.$inject=["$http","API_URL","$q"]}(),function(){function BookSelectorStateService(){function subscribe(topic,fn){subscriptions[topic]=fn}function unsubscribe(topic){delete subscriptions[topic]}function publish(topic){subscriptions[topic]()}var subscriptions=[];return{subscribe:subscribe,unsubscribe:unsubscribe,publish:publish}}angular.module("app.core").service("BookSelectorStateService",BookSelectorStateService)}(),function(){function ModalStateService(){function clear(){openFns=[]}function open(verseId){if(0===openFns.length)return!1;for(var i=0;i<openFns.length;i++)openFns[i](verseId)}function close(){return null!=closeFn&&void closeFn()}function onOpen(callback){openFns.push(callback)}function onClose(callback){closeFn=callback}var openFns=[],closeFn=null;return{open:open,onOpen:onOpen,close:close,onClose:onClose,clear:clear}}angular.module("app.core").service("ModalStateService",ModalStateService)}(),function(){function SearchStateService(){function onReady(fn){subscriptionFns.push(fn)}function unsubscribe(){subscriptionFns=[]}function ready(){if(0!==subscriptionFns.length)for(var i=0;i<subscriptionFns.length;i++)subscriptionFns[i]()}var subscriptionFns=[];return{onReady:onReady,unsubscribe:unsubscribe,ready:ready}}angular.module("app.core").service("SearchStateService",SearchStateService)}(),function(){function TitleStateService(){function change(value){return null!=changeFn&&void changeFn(value)}function onChange(callback){changeFn=callback}var changeFn=null;return{change:change,onChange:onChange}}angular.module("app.core").service("TitleStateService",TitleStateService)}(),function(){function TranslationStateService($cookies,$stateParams,DEFAULT_TRANSLATION){function change(translation){$cookies.put("translation",translation.abbreviation);for(var key in changeFns)changeFns.hasOwnProperty(key)&&null!=changeFns[key]&&changeFns[key](translation)}function onChange(key,callback){changeFns[key]=callback}function getCurrent(){return $cookies.get("translation")}var changeFns={};return $stateParams.hasOwnProperty("translation")&&$cookies.put("translation",$stateParams.translation),"undefined"==typeof $cookies.get("translation")&&$cookies.put("translation",DEFAULT_TRANSLATION),{change:change,onChange:onChange,getCurrent:getCurrent}}angular.module("app.core").service("TranslationStateService",["$cookies","$stateParams","DEFAULT_TRANSLATION",TranslationStateService])}();