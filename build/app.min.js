"use strict";angular.module("app.core",[]),angular.module("app",["ngRoute","ui.router","ngSanitize","ngCookies","app.core"]).config(["$stateProvider","$httpProvider","$locationProvider",function($stateProvider,$httpProvider,$locationProvider){$stateProvider.state("home",{url:"/",templateUrl:"/js/views/controllers/home.html",controller:"HomeController",controllerAs:"vm"}).state("home.book",{url:"books/:bookId/:chapterId?verseId",templateUrl:"/js/views/controllers/book.html",controller:"BookController",controllerAs:"vm"}),$locationProvider.html5Mode(!0)}]);var coreAppEnv={};window&&(coreAppEnv=angular.extend(coreAppEnv,window.__coreAppEnv)),angular.module("app.core").value("URL",coreAppEnv.URL).value("API_URL",coreAppEnv.API_URL).value("DEFAULT_TRANSLATION",coreAppEnv.DEFAULT_TRANSLATION),function(){function BookController($scope,$state,$stateParams,ApiService,ModalStateService,TranslationStateService,BookSelectorStateService){function init(){vm.book={},ApiService.getText(bookId,chapterId,TranslationStateService.getCurrent()).then(function(data){vm.versesLeft=[],vm.versesRight=[],vm.book=data[0].book;for(var i=0;i<data.length;i++)null!==verseId&&data[i].id==verseId&&(data[i].highlight=!0),i<data.length/2?vm.versesLeft.push(data[i]):vm.versesRight.push(data[i])})}function onKeyDownEvent(e){27===e.keyCode&&(ModalStateService.close(),$scope.$apply()),39===e.keyCode&&BookSelectorStateService.publish("next"),37===e.keyCode&&BookSelectorStateService.publish("previous")}function open(placement,verse){var element=document.getElementById("crossReferenceModal");element.style.left=null,element.style.left=null,"left"===placement?element.style.left=0:element.style.right=0,ModalStateService.open(verse)}var vm=this;vm.book={},vm.versesLeft=[],vm.versesRight=[],vm.open=open;var bookId=1,chapterId=1,verseId=null;$stateParams.hasOwnProperty("bookId")&&(bookId=$stateParams.bookId),$stateParams.hasOwnProperty("chapterId")&&(chapterId=$stateParams.chapterId),$stateParams.hasOwnProperty("verseId")&&(verseId=$stateParams.verseId),TranslationStateService.clearOnChangeListeners(),TranslationStateService.onChange(function(){init()}),init(),document.body.onkeydown=onKeyDownEvent}angular.module("app.core").controller("BookController",BookController),BookController.$inject=["$scope","$state","$stateParams","ApiService","ModalStateService","TranslationStateService","BookSelectorStateService"]}(),function(){function HomeController($state){"home"===$state.$current.name&&$state.go("home.book",{bookId:1,chapterId:1},{reload:!0})}angular.module("app.core").controller("HomeController",HomeController),HomeController.$inject=["$state"]}(),function(){function bookSelector(){return{restrict:"E",scope:{},controller:ctrl,controllerAs:"vm",bindToController:!0,templateUrl:"/js/views/directives/book-selector.html"}}function ctrl($scope,ApiService,$q,$state,$stateParams,BookSelectorStateService){function getBooks(){return ApiService.getBooks().then(function(books){for(var tag="(OT)",i=0;i<books.length;i++)i>=39&&(tag="(NT)"),books[i].name=books[i].name+" "+tag;return vm.books=books,setSelectedBook(stateBookId),stateBookId}).then(ApiService.getChaptersFromBook).then(function(chapters){vm.chapters=chapters,setSelectedChapter(stateChapterId)})["finally"](function(){vm.isLoading=!1})}function onSelectBook(book){setSelectedChapter(1),ApiService.getChaptersFromBook(book.id).then(function(chapters){vm.chapters=chapters}),checkBtnState(book.id,1),$state.go("home.book",{bookId:book.id,chapterId:1})}function onSelectChapter(chapter){checkBtnState(vm.selected.book.id,chapter.id),$state.go("home.book",{bookId:vm.selected.book.id,chapterId:chapter.id})}function onPreviousClick(){var bookId=vm.selected.book.id,chapterId=vm.selected.chapter.id;chapterId-1===0?(bookId--,vm.isLoading=!0,ApiService.getChaptersFromBook(bookId).then(function(chapters){vm.chapters=chapters,vm.isLoading=!1,setSelectedBook(bookId),setSelectedChapter(chapters.length),checkBtnState(bookId,chapters.length),$state.go("home.book",{bookId:bookId,chapterId:chapters.length})})):(chapterId--,setSelectedChapter(chapterId),checkBtnState(bookId,chapterId),$state.go("home.book",{bookId:bookId,chapterId:chapterId}))}function onNextClick(){var maxChapters=vm.chapters.length,bookId=vm.selected.book.id,chapterId=vm.selected.chapter.id;chapterId+1>maxChapters?(bookId++,chapterId=1,$scope.isLoading=!0,ApiService.getChaptersFromBook(bookId).then(function(chapters){vm.chapters=chapters,$scope.isLoading=!1})):chapterId++,setSelectedBook(bookId),setSelectedChapter(chapterId),checkBtnState(bookId,chapterId),$state.go("home.book",{bookId:bookId,chapterId:chapterId})}function setSelectedBook(bookId){for(var index in vm.books)if(vm.books[index].id===bookId){vm.selected.book=vm.books[index];break}null==vm.selected.book.id&&(vm.selected.book=vm.books[0])}function setSelectedChapter(chapterId){for(var index in vm.chapters)if(vm.chapters[index].id===chapterId){vm.selected.chapter=vm.chapters[index];break}null==vm.selected.chapter.id&&(vm.selected.chapter=vm.chapters[0])}function checkBtnState(bookId,chapterId){vm.disablePreviousBtn=1===bookId&&1===chapterId,vm.disableNextBtn=66===bookId&&22===chapterId}var vm=this;vm.books=[],vm.selected={book:{id:null},chapter:{id:null}},vm.disablePreviousBtn=!1,vm.disableNextBtn=!1,vm.isLoading=!0,vm.onSelectBook=onSelectBook,vm.onSelectChapter=onSelectChapter,vm.onPreviousClick=onPreviousClick,vm.onNextClick=onNextClick;var stateBookId=parseInt($stateParams.bookId),stateChapterId=parseInt($stateParams.chapterId);checkBtnState(stateBookId,stateChapterId),getBooks(),BookSelectorStateService.subscribe("next",function(){return!vm.disableNextBtn&&void vm.onNextClick()}),BookSelectorStateService.subscribe("previous",function(){return!vm.disablePreviousBtn&&void vm.onPreviousClick()})}angular.module("app.core").directive("bookSelector",bookSelector),ctrl.$inject=["$scope","ApiService","$q","$state","$stateParams","BookSelectorStateService"]}(),function(){function crossReferenceModal(){return{restrict:"E",scope:{},controller:ctrl,controllerAs:"vm",bindToController:!0,templateUrl:"/js/views/directives/cross-reference-modal.html"}}function ctrl($scope,ApiService,ModalStateService,TranslationStateService){function init(){ApiService.getCrossReferences(currentVerse.id,TranslationStateService.getCurrent()).then(function(data){vm.relatedVerses=data,vm.isLoading=!1})}function close(){vm.isOpen=!1}var vm=this;vm.verse={},vm.relatedVerses=[],vm.isOpen=!1,vm.close=close;var currentVerse=null;TranslationStateService.onChange(function(){return!!vm.isOpen&&void init()}),ModalStateService.onOpen(function(verse){null!==currentVerse&&(currentVerse.highlight=!1),currentVerse=verse,currentVerse.highlight=!0,vm.isOpen=!0,vm.isLoading=!0,init()}),ModalStateService.onClose(function(){vm.isOpen=!1})}angular.module("app.core").directive("crossReferenceModal",crossReferenceModal),ctrl.$inject=["$scope","ApiService","ModalStateService","TranslationStateService"]}(),function(){function translationSelector(){return{restrict:"E",scope:{},controller:ctrl,controllerAs:"vm",bindToController:!0,templateUrl:"/js/views/directives/translation-selector.html"}}function ctrl($scope,ApiService,$q,TranslationStateService){function getTranslations(){return ApiService.getTranslations().then(function(translations){for(var i=0;i<translations.length;i++)translations[i].name=translations[i].abbreviation+" - "+translations[i].version,TranslationStateService.getCurrent()==translations[i].abbreviation&&(vm.selected.translation=translations[i]);vm.translations=translations,vm.isLoading=!1})}function onSelectTranslation(translation){TranslationStateService.change(translation)}var vm=this;vm.translations=[],vm.selected={translation:null},vm.isLoading=!0,vm.onSelectTranslation=onSelectTranslation,getTranslations()}angular.module("app.core").directive("translationSelector",translationSelector),ctrl.$inject=["$scope","ApiService","$q","TranslationStateService"]}(),function(){function ApiService($http,API_URL,$q){function getTranslations(){return _get("/translations")}function getCrossReferences(verseId,translation){return _get("/verse/"+verseId+"/relations",{params:{translation:translation}})}function getBooks(){return _get("/books")}function getChaptersFromBook(bookId){return _get("/books/"+bookId+"/chapters")}function getMaxChapterFromBook(bookId){var deferred=$q.defer();return _get("/books/"+bookId+"/chapters").then(function(data){deferred.resolve(data[data.length-1].id)})["catch"](function(){deferred.reject()}),deferred.promise}function getText(bookId,chapterId,translation){return _get("/books/"+bookId+"/chapters/"+chapterId,{params:{translation:translation}})}function _getHttpOptions(endpoint,options){var defaultOptions={},httpOptions={};return httpOptions="object"==typeof options?angular.extend(options,defaultOptions):defaultOptions}function _get(endpoint,options){var url=API_URL+endpoint,httpOptions=_getHttpOptions(endpoint,options);return $http.get(url,httpOptions).then(function(response){return response.data})}return{getTranslations:getTranslations,getCrossReferences:getCrossReferences,getBooks:getBooks,getChaptersFromBook:getChaptersFromBook,getMaxChapterFromBook:getMaxChapterFromBook,getText:getText}}angular.module("app.core").service("ApiService",["$http","API_URL","$q",ApiService])}(),function(){function BookSelectorStateService(){function subscribe(topic,fn){subscriptions[topic]=fn}function unsubscribe(topic){delete subscriptions[topic]}function publish(topic){subscriptions[topic]()}var subscriptions=[];return{subscribe:subscribe,unsubscribe:unsubscribe,publish:publish}}angular.module("app.core").service("BookSelectorStateService",BookSelectorStateService)}(),function(){function ModalStateService(){function open(verseId){return null!=openFn&&void openFn(verseId)}function close(){return null!=closeFn&&void closeFn()}function onOpen(callback){openFn=callback}function onClose(callback){closeFn=callback}var openFn=null,closeFn=null;return{open:open,onOpen:onOpen,close:close,onClose:onClose}}angular.module("app.core").service("ModalStateService",ModalStateService)}(),function(){function TranslationStateService($cookies,DEFAULT_TRANSLATION){function change(translation){$cookies.put("translation",translation.abbreviation);for(var i=0;i<changeFns.length;i++)changeFns[i](translation)}function onChange(callback){changeFns.push(callback)}function getCurrent(){return $cookies.get("translation")}function clearOnChangeListeners(){changeFns=[]}var changeFns=[];return"undefined"==typeof $cookies.get("translation")&&$cookies.put("translation",DEFAULT_TRANSLATION),{change:change,onChange:onChange,getCurrent:getCurrent,clearOnChangeListeners:clearOnChangeListeners}}angular.module("app.core").service("TranslationStateService",["$cookies","DEFAULT_TRANSLATION",TranslationStateService])}();